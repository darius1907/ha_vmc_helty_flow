# ============================================================
# CONFIGURAZIONE STORICO RISCALDAMENTO CON UTILITY METER
# ============================================================
#
# Aggiungi questo codice al tuo configuration.yaml
# o crea file separati in packages/
#
# VANTAGGI:
# âœ… Storico automatico (giornaliero, settimanale, mensile, annuale)
# âœ… Grafici nativi di Home Assistant
# âœ… Nessun codice custom necessario
# âœ… Reset automatici
# âœ… Database ottimizzato
#
# ============================================================

# --- ESEMPIO PER 1 VALVOLA (Soggiorno) ---
# Replica questo blocco per ogni valvola cambiando i nomi

input_number:
  # Contatore ore giornaliero (usato dal blueprint)
  heating_hours_soggiorno:
    name: Ore Riscaldamento Soggiorno (Oggi)
    min: 0
    max: 24
    step: 0.01
    unit_of_measurement: "h"
    mode: box
    icon: mdi:radiator

  # Contatore cumulativo (per statistiche a lungo termine)
  heating_cumulative_soggiorno:
    name: Ore Riscaldamento Soggiorno (Cumulativo)
    min: 0
    max: 100000
    step: 0.01
    unit_of_measurement: "h"
    mode: box
    icon: mdi:counter

input_text:
  # Memorizza l'orario di accensione
  heating_start_soggiorno:
    name: Riscaldamento Soggiorno - Ultimo Avvio
    max: 50
    icon: mdi:clock-start

# --- UTILITY METER PER STATISTICHE ---
utility_meter:
  # Statistiche GIORNALIERE
  heating_daily_soggiorno:
    source: input_number.heating_cumulative_soggiorno
    cycle: daily
    name: Riscaldamento Soggiorno (Giornaliero)
    cron: "0 0 * * *"  # Reset a mezzanotte

  # Statistiche SETTIMANALI
  heating_weekly_soggiorno:
    source: input_number.heating_cumulative_soggiorno
    cycle: weekly
    name: Riscaldamento Soggiorno (Settimanale)

  # Statistiche MENSILI
  heating_monthly_soggiorno:
    source: input_number.heating_cumulative_soggiorno
    cycle: monthly
    name: Riscaldamento Soggiorno (Mensile)

  # Statistiche ANNUALI
  heating_yearly_soggiorno:
    source: input_number.heating_cumulative_soggiorno
    cycle: yearly
    name: Riscaldamento Soggiorno (Annuale)

# ============================================================
# TEMPLATE SENSOR PER CALCOLI AVANZATI (OPZIONALE)
# ============================================================

sensor:
  - platform: template
    sensors:
      # Costo energetico giornaliero (esempio: â‚¬0.30/kWh)
      heating_cost_daily_soggiorno:
        friendly_name: "Costo Riscaldamento Soggiorno (Oggi)"
        unit_of_measurement: "â‚¬"
        value_template: >
          {{ (states('sensor.heating_daily_soggiorno') | float(0) * 0.30) | round(2) }}
        icon_template: mdi:cash

      # Media ore giornaliere ultimo mese
      heating_avg_daily_soggiorno:
        friendly_name: "Media Giornaliera Riscaldamento Soggiorno"
        unit_of_measurement: "h"
        value_template: >
          {% set monthly = states('sensor.heating_monthly_soggiorno') | float(0) %}
          {% set days = now().day %}
          {{ (monthly / days) | round(1) if days > 0 else 0 }}
        icon_template: mdi:chart-line

      # Percentuale utilizzo giornaliero
      heating_usage_percentage_soggiorno:
        friendly_name: "Utilizzo Riscaldamento Soggiorno (%)"
        unit_of_measurement: "%"
        value_template: >
          {% set hours = states('input_number.heating_hours_soggiorno') | float(0) %}
          {{ ((hours / 24) * 100) | round(1) }}
        icon_template: mdi:percent

# ============================================================
# AUTOMAZIONE PER BACKUP STORICO (OPZIONALE)
# ============================================================
# Salva i dati mensili in un file CSV per backup esterno

automation:
  - alias: "Backup Mensile Statistiche Riscaldamento"
    trigger:
      - platform: time
        at: "23:59:00"
    condition:
      - condition: template
        value_template: "{{ now().day == (now() + timedelta(days=1)).replace(day=1).day }}"
    action:
      - service: notify.persistent_notification
        data:
          title: "ðŸ“Š Backup Statistiche Riscaldamento"
          message: >
            Mese: {{ now().strftime('%B %Y') }}

            Soggiorno: {{ states('sensor.heating_monthly_soggiorno') }}h
            Costo: â‚¬{{ (states('sensor.heating_monthly_soggiorno') | float(0) * 0.30) | round(2) }}

# ============================================================
# REPLICA PER ALTRE VALVOLE
# ============================================================
#
# Per aggiungere altre valvole, copia il blocco sopra e cambia:
# - soggiorno -> camera_letto
# - soggiorno -> bagno
# - soggiorno -> cucina
# etc.
#
# Esempio:
#
# input_number:
#   heating_hours_camera:
#     name: Ore Riscaldamento Camera
#     ...
#
#   heating_cumulative_camera:
#     name: Ore Riscaldamento Camera (Cumulativo)
#     ...
#
# utility_meter:
#   heating_daily_camera:
#     source: input_number.heating_cumulative_camera
#     ...
#
# ============================================================
