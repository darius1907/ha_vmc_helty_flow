blueprint:
  name: Controllo Intelligente Valvola termostatica con Comfort e Allarmi
  description: Regola automaticamente il termostato della stanza in base alla temperatura desiderata, umiditÃ , punto di rugiada e comfort, con allarmi opzionali.
  domain: automation
  input:
    temperature_sensor:
      name: Sensore temperatura
      description: Il sensore che rileva la temperatura della stanza
      selector:
        entity:
          domain: sensor
    humidity_sensor:
      name: Sensore umiditÃ  (opzionale)
      description: Sensore per il calcolo del punto di rugiada e comfort
      default: ""
      selector:
        entity:
          domain: sensor
    thermostat:
      name: Termostato
      description: Il termostato da controllare
      selector:
        entity:
          domain: climate
    target_temperature_input:
      name: Temperatura desiderata
      description: L'input_number che definisce la temperatura target
      selector:
        entity:
          domain: input_number
    update_interval:
      name: Intervallo di aggiornamento (minuti)
      description: Ogni quanti minuti controllare la temperatura
      default: 5
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: minutes
    enable_alerts:
      name: Abilita Allarmi
      description: Attiva notifiche automatiche per temperature o umiditÃ  critiche
      default: false
      selector:
        boolean: {}
    high_humidity_threshold:
      name: Soglia umiditÃ  alta (%)
      description: Valore oltre il quale scatta l'allarme umiditÃ 
      default: 70
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
    low_humidity_threshold:
      name: Soglia umiditÃ  bassa (%)
      description: Valore sotto il quale scatta l'allarme umiditÃ 
      default: 30
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
    high_temperature_threshold:
      name: Temperatura massima critica (Â°C)
      description: Valore oltre il quale scatta l'allarme temperatura
      default: 28
      selector:
        number:
          min: 0
          max: 50
          unit_of_measurement: "Â°C"
    low_temperature_threshold:
      name: Temperatura minima critica (Â°C)
      description: Valore sotto il quale scatta l'allarme temperatura
      default: 15
      selector:
        number:
          min: 0
          max: 50
          unit_of_measurement: "Â°C"

trigger:
  - platform: time_pattern
    minutes: "/{{ update_interval }}"
  - platform: state
    entity_id: !input temperature_sensor
    for:
      seconds: 30
  - platform: state
    entity_id: !input target_temperature_input
  - platform: state
    entity_id: !input humidity_sensor

variables:
  desired_temp: "{{ states(!input target_temperature_input) | float(21) }}"
  current_temp: "{{ states(!input temperature_sensor) | float(20) }}"
  current_target: "{{ state_attr(!input thermostat, 'temperature') | float(20) }}"
  diff: "{{ current_temp - desired_temp }}"
  current_humidity: >
    {% if !input humidity_sensor %}
      50
    {% else %}
      {{ states(!input humidity_sensor) | float(50) }}
    {% endif %}
  dew_point: >
    {{ (current_temp - ((100 - current_humidity)/5)) | round(1) }}
  comfort_index: >
    {{ (current_temp - 0.55*(1-current_humidity/100)*(current_temp-14.5)) | round(1) }}

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ diff >= 0.3 }}"
          - condition: template
            value_template: "{{ current_target > 10 }}"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostat
            data:
              temperature: 5
              hvac_mode: heat
          - service: notify.persistent_notification
            data:
              message: >
                âœ… {{ !input thermostat }}: {{ current_temp }}Â°C â†’ Target ridotto a 5Â°C
                ğŸŒ¡ Punto di rugiada: {{ dew_point }}Â°C
                ğŸ›‹ Comfort: {{ comfort_index }}Â°C
      - conditions:
          - condition: template
            value_template: "{{ diff < -0.5 }}"
          - condition: template
            value_template: "{{ current_target < 15 }}"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostat
            data:
              temperature: "{{ desired_temp }}"
              hvac_mode: heat
          - service: notify.persistent_notification
            data:
              message: >
                ğŸ”¥ {{ !input thermostat }}: {{ current_temp }}Â°C â†’ Target {{ desired_temp }}Â°C
                ğŸŒ¡ Punto di rugiada: {{ dew_point }}Â°C
                ğŸ›‹ Comfort: {{ comfort_index }}Â°C
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_alerts }}"
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: !input humidity_sensor
                above: !input high_humidity_threshold
              - condition: numeric_state
                entity_id: !input humidity_sensor
                below: !input low_humidity_threshold
              - condition: numeric_state
                entity_id: !input temperature_sensor
                above: !input high_temperature_threshold
              - condition: numeric_state
                entity_id: !input temperature_sensor
                below: !input low_temperature_threshold
        sequence:
          - service: notify.persistent_notification
            data:
              message: >
                âš ï¸ Allarme Stanza {{ !input thermostat }}:
                Temperatura: {{ current_temp }}Â°C (Min: {{ low_temperature_threshold }}, Max: {{ high_temperature_threshold }})
                UmiditÃ : {{ current_humidity }}% (Min: {{ low_humidity_threshold }}, Max: {{ high_humidity_threshold }})
                ğŸŒ¡ Punto di rugiada: {{ dew_point }}Â°C
                ğŸ›‹ Comfort: {{ comfort_index }}Â°C

mode: restart
