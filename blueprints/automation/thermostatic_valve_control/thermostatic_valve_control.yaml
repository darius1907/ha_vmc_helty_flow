blueprint:
  name: Controllo Riscaldamento Completo Settimanale
  description: Controllo integrato del riscaldamento con programmazione, regolazione intelligente, comfort e allarmi opzionali.
  domain: automation
  input:
    target_input:
      name: Input_number da regolare
      description: Input_number della stanza da controllare (o gruppo)
      selector:
        entity:
          domain: input_number
    thermostat:
      name: Termostato
      description: Termostato da controllare
      selector:
        entity:
          domain: climate
    temperature_sensor:
      name: Sensore temperatura
      description: Sensore temperatura stanza
      selector:
        entity:
          domain: sensor
    humidity_sensor:
      name: Sensore umiditÃ  (opzionale)
      description: Sensore umiditÃ  per comfort e punto di rugiada
      default: ""
      selector:
        entity:
          domain: sensor

    # Fasce orarie comuni
    morning_time:
      name: Ora mattina
      default: "06:30:00"
      selector:
        time: {}
    day_away_time:
      name: Ora giorno fuori casa
      default: "08:30:00"
      selector:
        time: {}
    mid_day_time:
      name: Ora metÃ  giornata
      default: "12:00:00"
      selector:
        time: {}
    evening_time:
      name: Ora sera
      default: "17:30:00"
      selector:
        time: {}
    night_time:
      name: Ora notte
      default: "22:30:00"
      selector:
        time: {}

    # Temperature feriali
    weekday_morning_temp:
      name: Temperatura mattina feriali
      default: 22
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"
    weekday_day_away_temp:
      name: Temperatura giorno fuori feriali
      default: 18
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"
    weekday_mid_day_temp:
      name: Temperatura metÃ  giornata feriali
      default: 22
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"
    weekday_evening_temp:
      name: Temperatura sera feriali
      default: 22
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"
    weekday_night_temp:
      name: Temperatura notte feriali
      default: 18
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"

    # Temperature weekend
    weekend_morning_temp:
      name: Temperatura mattina weekend
      default: 22
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"
    weekend_day_away_temp:
      name: Temperatura giorno fuori weekend
      default: 20
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"
    weekend_mid_day_temp:
      name: Temperatura metÃ  giornata weekend
      default: 22
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"
    weekend_evening_temp:
      name: Temperatura sera weekend
      default: 22
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"
    weekend_night_temp:
      name: Temperatura notte weekend
      default: 18
      selector:
        number:
          min: 10
          max: 30
          unit_of_measurement: "Â°C"

    # Allarmi opzionali
    enable_alerts:
      name: Abilita allarmi
      default: false
      selector:
        boolean: {}
    high_humidity_threshold:
      name: Soglia umiditÃ  alta (%)
      default: 70
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
    low_humidity_threshold:
      name: Soglia umiditÃ  bassa (%)
      default: 30
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
    high_temperature_threshold:
      name: Temperatura massima critica (Â°C)
      default: 28
      selector:
        number:
          min: 0
          max: 50
          unit_of_measurement: "Â°C"
    low_temperature_threshold:
      name: Temperatura minima critica (Â°C)
      default: 15
      selector:
        number:
          min: 0
          max: 50
          unit_of_measurement: "Â°C"

trigger:
  - platform: time
    at: !input morning_time
    id: morning
  - platform: time
    at: !input day_away_time
    id: day_away
  - platform: time
    at: !input mid_day_time
    id: mid_day
  - platform: time
    at: !input evening_time
    id: evening
  - platform: time
    at: !input night_time
    id: night
  - platform: state
    entity_id: !input temperature_sensor
    for:
      seconds: 30
  - platform: state
    entity_id: !input humidity_sensor
  - platform: state
    entity_id: !input target_input

variables:
  temperature_sensor: !input temperature_sensor
  thermostat: !input thermostat
  humidity_sensor: !input humidity_sensor
  target_input: !input target_input

  desired_temp: "{{ states(target_input) | float(21) }}"
  current_temp: "{{ states(temperature_sensor) | float(20) }}"
  current_target: "{{ state_attr(thermostat, 'temperature') | float(20) }}"
  diff: "{{ current_temp - desired_temp }}"
  current_humidity: >
    {% if humidity_sensor != '' %}
      {{ states(humidity_sensor) | float(50) }}
    {% else %}
      50
    {% endif %}
  dew_point: >
    {{ (current_temp - ((100 - current_humidity)/5)) | round(1) }}
  comfort_index: >
    {{ (current_temp - 0.55*(1-current_humidity/100)*(current_temp-14.5)) | round(1) }}

action:
  - choose:
      # --- Feriali ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: morning
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekday_morning_temp
          - service: notify.persistent_notification
            data:
              message: "ğŸŒ… Buongiorno (feriali)! Target {{ !input weekday_morning_temp }}Â°C"
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: day_away
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekday_day_away_temp
          - service: notify.persistent_notification
            data:
              message: "ğŸ¢ ModalitÃ  risparmio (feriali) target {{ !input weekday_day_away_temp }}Â°C"

      # --- Weekend ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: morning
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekend_morning_temp
          - service: notify.persistent_notification
            data:
              message: "ğŸŒ… Buongiorno (weekend)! Target {{ !input weekend_morning_temp }}Â°C"

  # --- Controllo dinamico termostato ---
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ diff >= 0.3 }}"
          - condition: template
            value_template: "{{ current_target > 10 }}"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostat
            data:
              temperature: 5
              hvac_mode: heat
          - service: notify.persistent_notification
            data:
              message: >
                âœ… {{ thermostat }}: {{ current_temp }}Â°C â†’ Target ridotto a 5Â°C
                ğŸŒ¡ Punto di rugiada: {{ dew_point }}Â°C
                ğŸ›‹ Comfort: {{ comfort_index }}Â°C
      - conditions:
          - condition: template
            value_template: "{{ diff < -0.5 }}"
          - condition: template
            value_template: "{{ current_target < 30 }}"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostat
            data:
              temperature: "{{ desired_temp }}"
              hvac_mode: heat
          - service: notify.persistent_notification
            data:
              message: >
                ğŸ”¥ {{ thermostat }}: {{ current_temp }}Â°C â†’ Target {{ desired_temp }}Â°C
                ğŸŒ¡ Punto di rugiada: {{ dew_point }}Â°C
                ğŸ›‹ Comfort: {{ comfort_index }}Â°C

  # --- Allarmi opzionali ---
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_alerts and (current_temp > !input high_temperature_threshold) }}"
        sequence:
          - service: notify.persistent_notification
            data:
              message: "âš ï¸ Temperatura eccessiva: {{ current_temp }}Â°C"
      - conditions:
          - condition: template
            value_template: "{{ enable_alerts and (current_temp < !input low_temperature_threshold) }}"
        sequence:
          - service: notify.persistent_notification
            data:
              message: "ğŸ¥¶ Temperatura troppo bassa: {{ current_temp }}Â°C"
      - conditions:
          - condition: template
            value_template: "{{ enable_alerts and (current_humidity > !input high_humidity_threshold) }}"
        sequence:
          - service: notify.persistent_notification
            data:
              message: "ğŸ’§ UmiditÃ  alta: {{ current_humidity }}%"
      - conditions:
          - condition: template
            value_template: "{{ enable_alerts and (current_humidity < !input low_humidity_threshold) }}"
        sequence:
          - service: notify.persistent_notification
            data:
              message: "ğŸœ UmiditÃ  bassa: {{ current_humidity }}%"

mode: restart
