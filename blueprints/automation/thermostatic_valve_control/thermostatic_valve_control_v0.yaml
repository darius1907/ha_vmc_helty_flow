blueprint:
  name: Controllo Riscaldamento Completo Settimanale
  description: >
      Controllo integrato del riscaldamento con programmazione, regolazione intelligente, comfort e allarmi opzionali.
  domain: automation
  input:
    target_input:
      name: Input_number da regolare
      description: Input_number della stanza da controllare (o gruppo)
      selector:
        entity:
          domain: input_number
    thermostat:
      name: Termostato
      description: Termostato da controllare
      selector:
        entity:
          domain: climate
    temperature_sensor:
      name: Sensore temperatura
      description: Sensore temperatura stanza
      selector:
        entity:
          domain: sensor
    humidity_sensor:
      name: Sensore umiditÃ  (opzionale)
      description: Sensore umiditÃ  per comfort e punto di rugiada
      default: ""
      selector:
        entity:
          domain: sensor

    # Fasce orarie comuni
    daylight_time:
      name: Ora alba
      default: "06:30:00"
      selector:
        time: {}
    morning_time:
      name: Ora mattina
      default: "08:30:00"
      selector:
        time: {}
    mid_day_time:
      name: Ora metÃ  giornata
      default: "11:30:00"
      selector:
        time: {}
    afternoon_time:
      name: Ora pomeriggio
      default: "14:30:00"
      selector:
        time: {}
    evening_time:
      name: Ora sera
      default: "17:30:00"
      selector:
        time: {}
    night_time:
      name: Ora notte
      default: "22:30:00"
      selector:
        time: {}

    # Temperature feriali
    weekday_daylight_temp:
      name: Temperatura alba feriali
      default: 21.5
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekday_morning_temp:
      name: Temperatura mattina feriali
      default: 18.0
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekday_mid_day_temp:
      name: Temperatura metÃ  giornata feriali
      default: 21.5
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekday_afternoon_temp:
      name: Temperatura pomeriggio feriali
      default: 18
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekday_evening_temp:
      name: Temperatura sera feriali
      default: 21.5
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekday_night_temp:
      name: Temperatura notte feriali
      default: 18.0
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"

    # Temperature weekend
    weekend_daylight_temp:
      name: Temperatura alba weekend
      default: 21.5
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekend_morning_temp:
      name: Temperatura mattina weekend
      default: 18.5
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekend_mid_day_temp:
      name: Temperatura metÃ  giornata weekend
      default: 21.5
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekend_afternoon_temp:
      name: Temperatura pomeriggio weekend
      default: 18
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekend_evening_temp:
      name: Temperatura sera weekend
      default: 21.5
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"
    weekend_night_temp:
      name: Temperatura notte weekend
      default: 18
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "Â°C"

    # Isteresi
    heating_diff_up:
      name: Soglia spegnimento (Â°C)
      description: Differenza positiva sopra la quale il riscaldamento si spegne.
      default: 0.2
      selector:
        number:
          min: 0
          max: 5
          step: 0.1
          unit_of_measurement: "Â°C"
    heating_diff_down:
      name: Soglia accensione (Â°C)
      description: Differenza negativa sotto la quale il riscaldamento si accende.
      default: -0.5
      selector:
        number:
          min: -5
          max: 0
          step: 0.1
          unit_of_measurement: "Â°C"

    # Allarmi opzionali
    enable_alerts:
      name: Abilita allarmi
      default: false
      selector:
        boolean: {}

    # Schedulazione ricorrente
#    enable_periodic_check:
#      name: Abilita controllo periodico
#      description: >
#        Attiva un controllo ricorrente ogni 5 minuti.
#        NOTA: L'intervallo Ã¨ fisso a 5 minuti (limitazione blueprint).
#        Per modificare, edita manualmente l'automazione dopo la creazione.
#      default: false
#      selector:
#        boolean: {}
    high_humidity_threshold:
      name: Soglia umiditÃ  alta (%)
      default: 75
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
    low_humidity_threshold:
      name: Soglia umiditÃ  bassa (%)
      default: 30
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
    high_temperature_threshold:
      name: Temperatura massima critica (Â°C)
      default: 28
      selector:
        number:
          min: 0
          max: 50
          unit_of_measurement: "Â°C"
    low_temperature_threshold:
      name: Temperatura minima critica (Â°C)
      default: 15
      selector:
        number:
          min: 0
          max: 50
          unit_of_measurement: "Â°C"

trigger:
  - platform: time
    at: !input daylight_time
    id: daylight
  - platform: time
    at: !input morning_time
    id: morning
  - platform: time
    at: !input mid_day_time
    id: mid_day
  - platform: time
    at: !input afternoon_time
    id: afternoon
  - platform: time
    at: !input evening_time
    id: evening
  - platform: time
    at: !input night_time
    id: night
  - platform: state
    entity_id: !input temperature_sensor
  - platform: state
    entity_id: !input humidity_sensor
  - platform: state
    entity_id: !input target_input
  # Trigger periodico ogni 5 minuti (configurabile tramite enable_periodic_check)
#  - platform: time_pattern
#    minutes: "/5"
#    id: periodic_check

variables:
  #enable_periodic_check: !input enable_periodic_check
  temperature_sensor: !input temperature_sensor
  thermostat: !input thermostat
  humidity_sensor: !input humidity_sensor
  target_input: !input target_input

  desired_temp: "{{ states(target_input) | float(21) }}"
  current_temp: "{{ states(temperature_sensor) | float(20) }}"
  current_target: "{{ state_attr(thermostat, 'temperature') | float(20) }}"
  diff: "{{ current_temp - desired_temp }}"
  diff_up: !input heating_diff_up
  diff_down: !input heating_diff_down
  current_humidity: >
    {% if humidity_sensor != '' %}
      {{ states(humidity_sensor) | float(50) }}
    {% else %}
      50
    {% endif %}
  dew_point: >
    {{ (current_temp - ((100 - current_humidity)/5)) | round(1) }}
  comfort_index: >
    {{ (current_temp - 0.55*(1-current_humidity/100)*(current_temp-14.5)) | round(1) }}
  enable_alerts: !input enable_alerts
  high_temperature_threshold: !input high_temperature_threshold
  low_temperature_threshold: !input low_temperature_threshold
  high_humidity_threshold: !input high_humidity_threshold
  low_humidity_threshold: !input low_humidity_threshold

action:
  # Log iniziale: trigger attivato
  - service: logbook.log
    data:
      name: "ğŸ”§ Controllo Riscaldamento"
      message: >
        Trigger: {{ trigger.id | default('unknown') }}
        | Temp: {{ current_temp }}Â°C â†’ Desired: {{ desired_temp }}Â°C
        | Diff: {{ diff }}Â°C | Humidity: {{ current_humidity }}%
      entity_id: !input thermostat

  # Verifica se il trigger periodico Ã¨ abilitato
#  - condition: template
#    value_template: >
#      {% if trigger.id == 'periodic_check' %}
#        {{ enable_periodic_check }}
#      {% else %}
#        true
#     {% endif %}

  # Log: condizione trigger periodico
#  - choose:
#      - conditions:
#          - condition: template
#            value_template: "{{ trigger.id == 'periodic_check' }}"
#        sequence:
#          - service: system_log.write
#            data:
#              level: debug
#              message: >
#                [Periodic Check] Abilitato={{ enable_periodic_check }}
#                | Temp={{ current_temp }}Â°C | Target={{ desired_temp }}Â°C | Diff={{ diff }}Â°C

  # Feriali
  - choose:
      # --- Feriali alba ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekend() < 5 }}"
          - condition: trigger
            id: daylight
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekday_daylight_temp
          - service: logbook.log
            data:
              name: "ğŸ“… Cambio Programmato"
              message: >
                Alba Feriali: {{ states(target_input) }}Â°C
                (Precedente: {{ states(target_input) | float - (weekday_daylight_temp | float - states(target_input) | float) }}Â°C)
              entity_id: !input target_input
          - service: notify.persistent_notification
            data:
              message: >
                ğŸŒ… [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Alba Feriali)
  - choose:
      # --- Feriali mattino ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: morning
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekday_morning_temp
          - service: notify.persistent_notification
            data:
              message: >
                â˜€ï¸ [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Mattino Feriali)
  - choose:
      # --- Feriali mezzogiorno ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: mid_day
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekday_mid_day_temp
          - service: notify.persistent_notification
            data:
              message: >
                â˜€ï¸ [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Mezzogiorno Feriali)
  - choose:
      # --- Feriali pomeriggio ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: afternoon
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekday_afternoon_temp
          - service: notify.persistent_notification
            data:
              message: >
                ğŸŒ¤ï¸ [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Pomeriggio Feriali)
  - choose:
      # --- Feriali sera ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: evening
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekday_evening_temp
          - service: notify.persistent_notification
            data:
              message: >
                ğŸŒ† [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Sera Feriali)
  - choose:
      # --- Feriali notte ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: night
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekday_night_temp
          - service: notify.persistent_notification
            data:
              message: >
                ğŸŒ™ [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Notte Feriali)
  # weekend
  - choose:
      # --- Weekend alba ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: daylight
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekend_daylight_temp
          - service: notify.persistent_notification
            data:
              message: >
                ğŸŒ… [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Alba Weekend)
  - choose:
      # --- Weekend mattino ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: morning
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekend_morning_temp
          - service: notify.persistent_notification
            data:
              message: >
                â˜€ï¸ [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Mattino Weekend)
  - choose:
      # --- Weekend mezzogiorno ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: mid_day
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekend_mid_day_temp
          - service: notify.persistent_notification
            data:
              message: >
                â˜€ï¸ [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Mezzogiorno Weekend)
  - choose:
      # --- Weekend pomeriggio ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: afternoon
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekend_afternoon_temp
          - service: notify.persistent_notification
            data:
              message: >
                ğŸŒ¤ï¸ [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Pomeriggio Weekend)
  - choose:
      # --- Weekend sera ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: evening
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekend_evening_temp
          - service: notify.persistent_notification
            data:
              message: >
                ğŸŒ† [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Sera Weekend)
  - choose:
      # --- Weekend notte ---
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: night
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input target_input
            data:
              value: !input weekend_night_temp
          - service: notify.persistent_notification
            data:
              message: >
                ğŸŒ™ [{{ now().strftime('%H:%M') }}] {{ state_attr(thermostat, 'friendly_name') }}: Temperatura impostata a {{ states(target_input) }}Â°C (Notte Weekend)

  # --- Controllo dinamico termostato ---
  - service: system_log.write
    data:
      level: debug
      message: >
        [Controllo Dinamico] Diff={{ diff }}Â°C (Up={{ diff_up }}Â°C, Down={{ diff_down }}Â°C)
        | Current={{ current_temp }}Â°C | Desired={{ desired_temp }}Â°C | Target={{ current_target }}Â°C

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ diff >= diff_up }}"
          - condition: template
            value_template: "{{ current_target > 10 }}"
        sequence:
          - service: logbook.log
            data:
              name: "â„ï¸ Riscaldamento SPENTO"
              message: >
                Temperatura raggiunta: {{ current_temp }}Â°C (Desired: {{ desired_temp }}Â°C)
                | Diff: +{{ diff }}Â°C (soglia: +{{ diff_up }}Â°C) â†’ Target: 5Â°C
              entity_id: !input thermostat
          - service: climate.set_temperature
            target:
              entity_id: !input thermostat
            data:
              temperature: 5
          - service: notify.persistent_notification
            data:
              message: >
                âœ… [{{ now().strftime('%H:%M') }}] â„ï¸ Riscaldamento SPENTO {{ state_attr(thermostat, 'friendly_name') }}: {{ current_temp }}Â°C â†’ Target ridotto a 5Â°C
                ğŸŒ¡ Punto di rugiada: {{ dew_point }}Â°C
                ğŸ›‹ Comfort: {{ comfort_index }}Â°C
      - conditions:
          - condition: template
            value_template: "{{ diff < diff_down }}"
          - condition: template
            value_template: "{{ current_target < 30 }}"
        sequence:
          - service: logbook.log
            data:
              name: "ğŸ”¥ Riscaldamento ACCESO"
              message: >
                Temperatura bassa: {{ current_temp }}Â°C (Desired: {{ desired_temp }}Â°C)
                | Diff: {{ diff }}Â°C (soglia: {{ diff_down }}Â°C) â†’ Target: {{ desired_temp }}Â°C
              entity_id: !input thermostat
          - service: climate.set_temperature
            target:
              entity_id: !input thermostat
            data:
              temperature: "{{ desired_temp }}"
              hvac_mode: heat
          - service: notify.persistent_notification
            data:
              message: >
                ğŸ”¥ [{{ now().strftime('%H:%M') }}] ğŸ”¥ Riscaldamento ACCESO {{ state_attr(thermostat, 'friendly_name') }}: {{ current_temp }}Â°C â†’ Target {{ desired_temp }}Â°C
                ğŸŒ¡ Punto di rugiada: {{ dew_point }}Â°C
                ğŸ›‹ Comfort: {{ comfort_index }}Â°C

  # --- Allarmi opzionali ---
  - service: system_log.write
    data:
      level: debug
      message: >
        [Allarmi] Enabled={{ enable_alerts }}
        | Temp={{ current_temp }}Â°C ({{ low_temperature_threshold }}-{{ high_temperature_threshold }}Â°C)
        | Humidity={{ current_humidity }}% ({{ low_humidity_threshold }}-{{ high_humidity_threshold }}%)

  - choose:
      # âš ï¸ Temperatura troppo alta
      - conditions:
          - condition: template
            value_template: "{{ enable_alerts and (current_temp > high_temperature_threshold) }}"
        sequence:
          - service: logbook.log
            data:
              name: "âš ï¸ ALLARME Temperatura Alta"
              message: >
                Temperatura critica: {{ current_temp }}Â°C
                | Soglia massima: {{ high_temperature_threshold }}Â°C
                | Eccesso: +{{ (current_temp - high_temperature_threshold) | round(1) }}Â°C
              entity_id: !input temperature_sensor
          - service: notify.persistent_notification
            data:
              message: >
                âš ï¸ Temperatura eccessiva: {{ current_temp }}Â°C (soglia: {{ high_temperature_threshold }}Â°C)
      # ğŸ¥¶ Temperatura troppo bassa
      - conditions:
          - condition: template
            value_template: "{{ enable_alerts and (current_temp < low_temperature_threshold) }}"
        sequence:
          - service: logbook.log
            data:
              name: "ğŸ¥¶ ALLARME Temperatura Bassa"
              message: >
                Temperatura critica: {{ current_temp }}Â°C
                | Soglia minima: {{ low_temperature_threshold }}Â°C
                | Deficit: {{ (low_temperature_threshold - current_temp) | round(1) }}Â°C
              entity_id: !input temperature_sensor
          - service: notify.persistent_notification
            data:
              message: >
                ğŸ¥¶ Temperatura troppo bassa: {{ current_temp }}Â°C (soglia: {{ low_temperature_threshold }}Â°C)
      # ğŸ’§ UmiditÃ  alta
      - conditions:
          - condition: template
            value_template: "{{ enable_alerts and (current_humidity > high_humidity_threshold) }}"
        sequence:
          - service: logbook.log
            data:
              name: "ğŸ’§ ALLARME UmiditÃ  Alta"
              message: >
                UmiditÃ  critica: {{ current_humidity }}%
                | Soglia massima: {{ high_humidity_threshold }}%
                | Punto di rugiada: {{ dew_point }}Â°C
              entity_id: !input humidity_sensor
          - service: notify.persistent_notification
            data:
              message: >
                ğŸ’§ UmiditÃ  alta: {{ current_humidity }}% (soglia: {{ high_humidity_threshold }}%)
      # ğŸœ UmiditÃ  bassa
      - conditions:
          - condition: template
            value_template: "{{ enable_alerts and (current_humidity < low_humidity_threshold) }}"
        sequence:
          - service: logbook.log
            data:
              name: "ğŸœ ALLARME UmiditÃ  Bassa"
              message: >
                UmiditÃ  critica: {{ current_humidity }}%
                | Soglia minima: {{ low_humidity_threshold }}%
                | Rischio aria secca
              entity_id: !input humidity_sensor
          - service: notify.persistent_notification
            data:
              message: >
                ğŸœ UmiditÃ  bassa: {{ current_humidity }}% (soglia: {{ low_humidity_threshold }}%)

mode: restart
