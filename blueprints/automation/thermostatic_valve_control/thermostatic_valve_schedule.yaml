# Blueprint per il controllo programmato del riscaldamento.
# Include gestione oraria, notifiche e logbook.
# Parametri base: clima, temperature programmabili.
# Autore: Dario Pezzoli. Ultima revisione: 2025-11.

blueprint:
  name: Schedulazione Riscaldamento Settimanale
  description: >
      Schedulazione del riscaldamento con programmazione e notifiche.
  domain: automation
  input:
    thermostat:
      name: Termostati da controllare
      description: Seleziona i termostati/valvole
      selector:
        entity:
          domain: climate
          multiple: true
    # Fasce orarie comuni
    daylight_time:
      name: Ora alba
      default: "06:30:00"
      selector:
        time: {}
    morning_time:
      name: Ora mattina
      default: "08:30:00"
      selector:
        time: {}
    mid_day_time:
      name: Ora metÃ  giornata
      default: "11:30:00"
      selector:
        time: {}
    afternoon_time:
      name: Ora pomeriggio
      default: "14:30:00"
      selector:
        time: {}
    evening_time:
      name: Ora sera
      default: "17:30:00"
      selector:
        time: {}
    night_time:
      name: Ora notte
      default: "22:30:00"
      selector:
        time: {}

    # Temperature feriali
    weekday_daylight_temp:
      name: Temperatura alba feriali
      default: 21
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekday_morning_temp:
      name: Temperatura mattina feriali
      default: 18.0
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekday_mid_day_temp:
      name: Temperatura metÃ  giornata feriali
      default: 21
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekday_afternoon_temp:
      name: Temperatura pomeriggio feriali
      default: 18
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekday_evening_temp:
      name: Temperatura sera feriali
      default: 21
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekday_night_temp:
      name: Temperatura notte feriali
      default: 18.0
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"

    # Temperature weekend
    weekend_daylight_temp:
      name: Temperatura alba weekend
      default: 21
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekend_morning_temp:
      name: Temperatura mattina weekend
      default: 18
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekend_mid_day_temp:
      name: Temperatura metÃ  giornata weekend
      default: 21
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekend_afternoon_temp:
      name: Temperatura pomeriggio weekend
      default: 18
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekend_evening_temp:
      name: Temperatura sera weekend
      default: 21
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"
    weekend_night_temp:
      name: Temperatura notte weekend
      default: 18
      selector:
        number:
          min: 5
          max: 24
          step: 1
          unit_of_measurement: "Â°C"

trigger:
  - platform: time
    at: !input daylight_time
    id: daylight
  - platform: time
    at: !input morning_time
    id: morning
  - platform: time
    at: !input mid_day_time
    id: mid_day
  - platform: time
    at: !input afternoon_time
    id: afternoon
  - platform: time
    at: !input evening_time
    id: evening
  - platform: time
    at: !input night_time
    id: night

variables:
  thermostat: !input thermostat
  weekday_morning_temp: !input weekday_morning_temp
  weekday_daylight_temp: !input weekday_daylight_temp
  weekday_mid_day_temp: !input weekday_mid_day_temp
  weekday_afternoon_temp: !input weekday_afternoon_temp
  weekday_evening_temp: !input weekday_evening_temp
  weekday_night_temp: !input weekday_night_temp
  weekend_morning_temp: !input weekend_morning_temp
  weekend_daylight_temp: !input weekend_daylight_temp
  weekend_mid_day_temp: !input weekend_mid_day_temp
  weekend_afternoon_temp: !input weekend_afternoon_temp
  weekend_evening_temp: !input weekend_evening_temp
  weekend_night_temp: !input weekend_night_temp

action:
  - service: logbook.log
    data:
      name: "ğŸ”§ Schedulazione Riscaldamento"
      message: >
        Trigger: {{ trigger.id | default('unknown') }}
  # Feriali
  - choose:
      # Feriali alba
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: daylight
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekday_daylight_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Alba Feriali: Temperatura impostata a {{ weekday_daylight_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      ğŸŒ… [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekday_daylight_temp }}Â°C (Alba Feriali)
      # Feriali mattino
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: morning
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekday_morning_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Mattino Feriali: Temperatura impostata a {{ weekday_morning_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      â˜€ï¸ [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekday_morning_temp }}Â°C (Mattino Feriali)
      # Feriali mezzogiorno
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: mid_day
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekday_mid_day_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Mezzogiorno Feriali: Temperatura impostata a {{ weekday_mid_day_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      â˜€ï¸ [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekday_mid_day_temp }}Â°C (Mezzogiorno Feriali)
      # Feriali pomeriggio
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: afternoon
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekday_afternoon_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Pomeriggio Feriali: Temperatura impostata a {{ weekday_afternoon_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      ğŸŒ¤ï¸ [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekday_afternoon_temp }}Â°C (Pomeriggio Feriali)
      # Feriali sera
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: evening
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekday_evening_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Sera Feriali: Temperatura impostata a {{ weekday_evening_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      ğŸŒ† [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekday_evening_temp }}Â°C (Sera Feriali)
      # Feriali notte
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() < 5 }}"
          - condition: trigger
            id: night
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekday_night_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Notte Feriali: Temperatura impostata a {{ weekday_night_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      ğŸŒ™ [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekday_night_temp }}Â°C (Notte Feriali)
  # Weekend
  - choose:
      # Weekend alba
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: daylight
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekend_daylight_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Alba Weekend: Temperatura impostata a {{ weekend_daylight_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      ğŸŒ… [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekend_daylight_temp }}Â°C (Alba Weekend)
      # Weekend mattino
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: morning
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekend_morning_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Mattino Weekend: Temperatura impostata a {{ weekend_morning_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      â˜€ï¸ [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekend_morning_temp }}Â°C (Mattino Weekend)
      # Weekend mezzogiorno
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: mid_day
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekend_mid_day_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Mezzogiorno Weekend: Temperatura impostata a {{ weekend_mid_day_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      â˜€ï¸ [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekend_mid_day_temp }}Â°C (Mezzogiorno Weekend)
      # Weekend pomeriggio
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: afternoon
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekend_afternoon_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Pomeriggio Weekend: Temperatura impostata a {{ weekend_afternoon_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      ğŸŒ¤ï¸ [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekend_afternoon_temp }}Â°C (Pomeriggio Weekend)
      # Weekend sera
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: evening
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekend_evening_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Sera Weekend: Temperatura impostata a {{ weekend_evening_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      ğŸŒ† [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekend_evening_temp }}Â°C (Sera Weekend)
      # Weekend notte
      - conditions:
          - condition: template
            value_template: "{{ now().weekday() >= 5 }}"
          - condition: trigger
            id: night
        sequence:
          - repeat:
              for_each: "{{ thermostat }}"
              sequence:
                - service: climate.set_temperature
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    temperature: "{{ weekend_night_temp }}"
                - service: logbook.log
                  data:
                    name: "ğŸ“… Cambio Programmato"
                    message: >
                      Notte Weekend: Temperatura impostata a {{ weekend_night_temp }}Â°C
                - service: notify.persistent_notification
                  data:
                    message: >
                      ğŸŒ™ [{{ now().strftime('%H:%M') }}] Temperatura impostata a {{ weekend_night_temp }}Â°C (Notte Weekend)
mode: restart