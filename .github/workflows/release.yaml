name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ— Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“ Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: ğŸ”„ Update manifest.json version
        run: |
          python3 << EOF
          import json

          manifest_path = 'custom_components/vmc_helty_flow/manifest.json'
          with open(manifest_path, 'r') as f:
              manifest = json.load(f)

          manifest['version'] = '${{ steps.version.outputs.version }}'

          with open(manifest_path, 'w') as f:
              json.dump(manifest, f, indent=2)
              f.write('\n')

          print(f"âœ… Updated manifest.json version to {manifest['version']}")
          EOF

      - name: ğŸ“¦ Create Release Archives
        run: |
          echo "ğŸ“¦ Creating release archives..."

          # Create integration archive for HACS
          cd custom_components
          zip -r ../vmc_helty_flow.zip vmc_helty_flow/ \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.egg-info/*"
          cd ..

          # Create complete package including Lovelace card
          zip -r vmc_helty_flow_complete.zip \
            custom_components/ \
            www/ \
            README.md \
            LICENSE \
            INFO.md \
            CHANGELOG.md \
            CONTRIBUTING.md \
            CODE_OF_CONDUCT.md \
            SECURITY.md \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.egg-info/*"

          echo "âœ… Archives created successfully"
          ls -lh *.zip

          echo "âœ… Archives created successfully"
          ls -lh *.zip

      - name: ğŸ“‹ Generate Release Notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## ğŸ“¦ Installation Files

          ### For HACS Users (Recommended)
          - **vmc_helty_flow.zip** - Integration only, automatically installed by HACS

          ### For Manual Installation
          - **vmc_helty_flow_complete.zip** - Complete package including:
            - Integration files
            - Lovelace card
            - Documentation

          ## ğŸš€ Quick Start

          ### Via HACS
          1. Open HACS in Home Assistant
          2. Go to Integrations
          3. Search for "VMC Helty Flow"
          4. Click Install
          5. Restart Home Assistant
          6. Add integration: Settings â†’ Devices & Services â†’ Add Integration â†’ VMC Helty Flow

          ### Manual Installation
          1. Download `vmc_helty_flow_complete.zip`
          2. Extract to your Home Assistant config directory:
             ```
             /config/custom_components/vmc_helty_flow/
             /config/www/vmc-helty-card/
             ```
          3. Restart Home Assistant
          4. Add integration from UI

          ## ğŸ“š Documentation

          - [Complete README](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Configuration Guide](https://github.com/${{ github.repository }}/blob/main/README.md#-configurazione-guidata)
          - [Lovelace Card Setup](https://github.com/${{ github.repository }}/blob/main/README.md#-dashboard-personalizzata)
          - [Troubleshooting](https://github.com/${{ github.repository }}/blob/main/README.md#-risoluzione-problemi)
          - [Contributing](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)

          ## ğŸ› Bug Reports

          Found an issue? [Open a bug report](https://github.com/${{ github.repository }}/issues/new?template=bug_report.md)

          ## ğŸ’¡ Feature Requests

          Have an idea? [Request a feature](https://github.com/${{ github.repository }}/issues/new?template=feature_request.md)

          ---

          **Compatibility:** Home Assistant 2024.1.0+
          **License:** MIT
          **Maintainer:** @darius1907

          â­ If you find this integration useful, please star the repository!
          EOF

          echo "âœ… Release notes generated"

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            vmc_helty_flow.zip
            vmc_helty_flow_complete.zip
          body_path: release_notes.md
          draft: true
          prerelease: false
          generate_release_notes: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Release Complete
        run: |
          echo "ğŸ‰ Release ${{ github.ref_name }} created successfully!"
          echo "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "ğŸ  HACS will automatically detect this release"
